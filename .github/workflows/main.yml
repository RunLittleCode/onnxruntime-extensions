name: build wheel linux aarch64
on: 
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive  # 必须包含子模块，否则编译会失败

      - name: Locate Build Script
        run: |
          # 自动寻找 build_android.py 的实际位置
          SCRIPT_PATH=$(find . -name "build_android.py" | head -n 1)
          if [ -z "$SCRIPT_PATH" ]; then
            echo "Error: build_android.py not found!"
            exit 1
          fi
          echo "SCRIPT_LOCATION=$SCRIPT_PATH" >> $GITHUB_ENV
          echo "Found script at: $SCRIPT_PATH"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Build Android Libraries
        run: |
          export ANDROID_NDK_HOME=$ANDROID_NDK_LATEST_HOME
          # 使用自动找到的路径运行脚本
          python3 ${{ env.SCRIPT_LOCATION }} \
            --config Release \
            --arch arm64-v8a \
            --sdk_path $ANDROID_HOME \
            --additional_params "-DCMAKE_SHARED_LINKER_FLAGS=-Wl,-z,max-page-size=16384"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: onnx-extensions-16kb-so
          # 这里的路径根据编译产物的实际位置调整，通常在 out 或 build 目录下
          path: |
            **/build/**/Release/**/*.so
            **/build/**/*.aar
