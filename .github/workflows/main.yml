name: Build ONNX Extensions 16KB
on: 
  workflow_dispatch: # 允许手动点击按钮触发
  push:
    branches: [ main ] # 提交代码时也会触发

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive # 必须包含子模块，否则 CMake 会因为找不到依赖报错

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Build Android Libraries
        run: |
          # 1. 赋予执行权限
          chmod +x build.sh

          # 2. 设置环境变量
          export ANDROID_NDK_HOME=$ANDROID_NDK_LATEST_HOME

          # 3. 运行构建脚本并透传 CMake 参数
          # 我们直接利用脚本中的 param="$@ ../../.." 将 Android 参数传给 CMake
          # -Wl,-z,max-page-size=16384 是修复 Android 15 兼容性的核心参数
          ./build.sh \
            -DCMAKE_SYSTEM_NAME=Android \
            -DCMAKE_ANDROID_ARCH_ABI=arm64-v8a \
            -DCMAKE_ANDROID_NDK=$ANDROID_NDK_LATEST_HOME \
            -DCMAKE_SYSTEM_VERSION=21 \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_SHARED_LINKER_FLAGS="-Wl,-z,max-page-size=16384" \
            -DORT_EXTENSIONS_BUILD_ANDROID=ON

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: onnx-extensions-16kb-so
          # 脚本中定义 target_dir=out/$OSNAME/$BUILD_FLAVOR
          # 所以产物通常在 out 目录下
          path: |
            out/**/*.so
            out/**/*.aar
            out/**/*.jar
